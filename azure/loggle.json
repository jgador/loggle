{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "17586252126798440586"
    }
  },
  "parameters": {
    "namePrefix": {
      "type": "string",
      "defaultValue": "loggle",
      "metadata": {
        "description": "Prefix applied to resource names (keep short and alphanumeric)."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure location / region for all resources in this deployment."
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "metadata": {
        "description": "VM SKU for the Loggle host."
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "loggle",
      "metadata": {
        "description": "Admin username for SSH access."
      }
    },
    "sshPublicKey": {
      "type": "string",
      "metadata": {
        "description": "SSH public key in OpenSSH format (single line)."
      }
    },
    "domainName": {
      "type": "string",
      "defaultValue": "kibana.loggle.co",
      "metadata": {
        "description": "Public hostname served by the stack (also used for TLS issuance)."
      }
    },
    "certificateEmail": {
      "type": "string",
      "defaultValue": "certbot@loggle.co",
      "metadata": {
        "description": "Contact email used for Let's Encrypt requests."
      }
    },
    "letsEncryptEnvironment": {
      "type": "string",
      "defaultValue": "production",
      "allowedValues": [
        "production",
        "staging"
      ],
      "metadata": {
        "description": "LetsEncrypt environment for certificate issuance. Leave at production for real deployments; switch to staging when repeatedly testing to avoid rate limits."
      }
    },
    "kibanaAllowedIps": {
      "type": "array",
      "defaultValue": [
        "0.0.0.0/0"
      ],
      "metadata": {
        "description": "IPv4 addresses or CIDR ranges allowed to reach Kibana / HTTPS. Default 0.0.0.0/0 leaves Kibana open to the entire internet - override this to restrict access."
      }
    },
    "extraTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional tags merged with the default workload tag."
      }
    },
    "resourceNames": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional explicit names for resources to override prefix-based defaults. Keys: virtualNetwork, subnet, networkSecurityGroup, networkInterface, virtualMachine, userAssignedIdentity, keyVault, osDisk."
      }
    },
    "publicIpName": {
      "type": "string",
      "metadata": {
        "description": "IMPORTANT: Name of the pre-existing public IP address that already exists in this resource group. The template only attaches to it; it will not create a new public IP."
      }
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional explicit Key Vault name. Leave empty to use the default prefix+date naming pattern."
      }
    },
    "assetRepoUrl": {
      "type": "string",
      "defaultValue": "https://github.com/jgador/loggle.git",
      "metadata": {
        "description": "Git repository that hosts the VM bootstrap assets (setup.sh, docker-compose.yml, etc.)."
      }
    },
    "assetRepoRef": {
      "type": "string",
      "defaultValue": "master",
      "metadata": {
        "description": "Git branch or tag used to download the assetRepoPath contents (normally azure/vm-assets). Defaults to master; change only when testing assets from another ref."
      }
    },
    "assetRepoPath": {
      "type": "string",
      "defaultValue": "azure/vm-assets",
      "metadata": {
        "description": "Path inside the repository that contains the VM bootstrap assets."
      }
    },
    "setupScriptUrl": {
      "type": "string",
      "defaultValue": "https://stlogglepublicprod.blob.core.windows.net/download/setup.sh",
      "metadata": {
        "description": "HTTPS endpoint that hosts setup.sh (fetched onto the VM before execution)."
      }
    },
    "keyVaultDateSuffix": {
      "type": "string",
      "defaultValue": "[utcNow('yyyyMMdd')]",
      "metadata": {
        "description": "Internal date stamp appended to generated Key Vault names.",
        "x-ms-visibility": "internal"
      }
    }
  },
  "variables": {
    "tags": "[union(createObject('workload', 'loggle'), parameters('extraTags'))]",
    "prefixSegment": "[if(empty(parameters('namePrefix')), '', format('{0}-', parameters('namePrefix')))]",
    "sanitizedNamePrefix": "[toLower(replace(parameters('namePrefix'), '-', ''))]",
    "defaultKeyVaultBaseName": "[if(empty(variables('sanitizedNamePrefix')), 'kvstore', format('{0}kv', variables('sanitizedNamePrefix')))]",
    "providedKeyVaultName": "[toLower(parameters('keyVaultName'))]",
    "vnetGeneratedName": "[format('{0}vnet', variables('prefixSegment'))]",
    "subnetGeneratedName": "default",
    "nsgGeneratedName": "[format('{0}nsg', variables('prefixSegment'))]",
    "nicGeneratedName": "[format('{0}nic', variables('prefixSegment'))]",
    "vmGeneratedName": "[format('{0}vm', variables('prefixSegment'))]",
    "identityGeneratedName": "[format('{0}id', variables('prefixSegment'))]",
    "keyVaultNameSeed": "[if(empty(parameters('keyVaultName')), format('{0}{1}', variables('defaultKeyVaultBaseName'), parameters('keyVaultDateSuffix')), variables('providedKeyVaultName'))]",
    "keyVaultGeneratedName": "[substring(variables('keyVaultNameSeed'), 0, min(24, length(variables('keyVaultNameSeed'))))]",
    "osDiskGeneratedName": "[format('{0}osdisk', variables('prefixSegment'))]",
    "vnetName": "[coalesce(tryGet(parameters('resourceNames'), 'virtualNetwork'), variables('vnetGeneratedName'))]",
    "subnetName": "[coalesce(tryGet(parameters('resourceNames'), 'subnet'), variables('subnetGeneratedName'))]",
    "nsgName": "[coalesce(tryGet(parameters('resourceNames'), 'networkSecurityGroup'), variables('nsgGeneratedName'))]",
    "nicName": "[coalesce(tryGet(parameters('resourceNames'), 'networkInterface'), variables('nicGeneratedName'))]",
    "vmName": "[coalesce(tryGet(parameters('resourceNames'), 'virtualMachine'), variables('vmGeneratedName'))]",
    "identityName": "[coalesce(tryGet(parameters('resourceNames'), 'userAssignedIdentity'), variables('identityGeneratedName'))]",
    "keyVaultEffectiveName": "[coalesce(tryGet(parameters('resourceNames'), 'keyVault'), variables('keyVaultGeneratedName'))]",
    "osDiskName": "[coalesce(tryGet(parameters('resourceNames'), 'osDisk'), variables('osDiskGeneratedName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[variables('identityName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]"
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "name": "[variables('keyVaultEffectiveName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "tenantId": "[tenant().tenantId]",
        "enableRbacAuthorization": true,
        "softDeleteRetentionInDays": 7,
        "publicNetworkAccess": "Enabled",
        "sku": {
          "name": "standard",
          "family": "A"
        },
        "networkAcls": {
          "defaultAction": "Allow",
          "bypass": "AzureServices"
        },
        "accessPolicies": []
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultEffectiveName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultEffectiveName')), 'cert-officer')]",
      "properties": {
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2023-01-31').principalId]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a4417e6f-fecd-4de8-b567-7b0420556985')]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultEffectiveName'))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultEffectiveName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultEffectiveName')), 'secret-user')]",
      "properties": {
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2023-01-31').principalId]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultEffectiveName'))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2023-02-01",
      "name": "[variables('vnetName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "10.0.0.0/16"
          ]
        }
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "apiVersion": "2023-02-01",
      "name": "[format('{0}/{1}', variables('vnetName'), variables('subnetName'))]",
      "properties": {
        "addressPrefix": "10.0.1.0/24"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2023-02-01",
      "name": "[variables('nsgName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "securityRules": [
          {
            "name": "SSH",
            "properties": {
              "priority": 100,
              "direction": "Inbound",
              "access": "Allow",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "22",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "Loggle",
            "properties": {
              "copy": [
                {
                  "name": "sourceAddressPrefixes",
                  "count": "[length(parameters('kibanaAllowedIps'))]",
                  "input": "[parameters('kibanaAllowedIps')[copyIndex('sourceAddressPrefixes')]]"
                }
              ],
              "priority": 110,
              "direction": "Inbound",
              "access": "Allow",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRanges": [
                "80",
                "443",
                "4318"
              ],
              "destinationAddressPrefix": "*"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-02-01",
      "name": "[variables('nicName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
        },
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetName'))]"
              },
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIpName'))]"
              }
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetName'))]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-09-01",
      "name": "[variables('vmName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')))]": {}
        }
      },
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('vmSize')]"
        },
        "osProfile": {
          "computerName": "[variables('vmName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": true,
            "ssh": {
              "publicKeys": [
                {
                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                  "keyData": "[parameters('sshPublicKey')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "canonical",
            "offer": "0001-com-ubuntu-minimal-jammy",
            "sku": "minimal-22_04-lts-gen2",
            "version": "latest"
          },
          "osDisk": {
            "name": "[variables('osDiskName')]",
            "createOption": "FromImage",
            "caching": "ReadWrite",
            "deleteOption": "Delete",
            "managedDisk": {
              "storageAccountType": "Standard_LRS"
            }
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2023-09-01",
      "name": "[format('{0}/{1}', variables('vmName'), 'loggleBootstrap')]",
      "location": "[parameters('location')]",
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.1",
        "autoUpgradeMinorVersion": true,
        "protectedSettings": {
          "commandToExecute": "[format('bash -c ''set -euo pipefail\nSETUP_URL=\"{0}\"\nREPO_URL=\"{1}\"\nREPO_REF=\"{2}\"\nREPO_PATH=\"{3}\"\nLOGGLE_HOME=\"/etc/loggle\"\nASSET_CACHE_DIR=\"$LOGGLE_HOME/assets\"\nSRC_DIR=\"$LOGGLE_HOME/repo\"\nBOOTSTRAP_SCRIPT=\"$LOGGLE_HOME/loggle-bootstrap.sh\"\nSTATE_FILE=\"$LOGGLE_HOME/bootstrap.completed\"\nINFRA_ENV_PATH=\"$LOGGLE_HOME/infra.env\"\n\ninstall -d -m 0755 \"$LOGGLE_HOME\"\ninstall -d -m 0755 \"$ASSET_CACHE_DIR\"\ninstall -d -m 0755 \"$(dirname \"$STATE_FILE\")\"\n\ncat <<''INFRAENV'' >\"$INFRA_ENV_PATH\"\nLOGGLE_KEY_VAULT_NAME=\"{8}\"\nLOGGLE_MANAGED_IDENTITY_CLIENT_ID=\"{6}\"\nINFRAENV\nchmod 600 \"$INFRA_ENV_PATH\"\n\nset +u\ncat <<''SCRIPT'' >\"$BOOTSTRAP_SCRIPT\"\n#!/bin/bash\nset -euo pipefail\n\nSETUP_URL=\"{0}\"\nREPO_URL=\"{1}\"\nREPO_REF=\"{2}\"\nREPO_PATH=\"{3}\"\nLOGGLE_HOME=\"/etc/loggle\"\nASSET_CACHE_DIR=\"$LOGGLE_HOME/assets\"\nSRC_DIR=\"$LOGGLE_HOME/repo\"\nSTATE_FILE=\"$LOGGLE_HOME/bootstrap.completed\"\nSETUP_SRC=\"$ASSET_CACHE_DIR/setup.sh\"\n\nif [[ -n \"$STATE_FILE\" && -f \"$STATE_FILE\" ]]; then\n    echo \"Loggle bootstrap already completed; remove $STATE_FILE to rerun.\"\n    exit 0\nfi\n\nif command -v cloud-init >/dev/null 2>&1; then\n    cloud-init status --wait\nfi\n\nensure_prereqs() {\n    if command -v git >/dev/null 2>&1 && command -v curl >/dev/null 2>&1; then\n        return\n    fi\n\n    export DEBIAN_FRONTEND=noninteractive\n    apt-get update -y\n    apt-get install -y git curl\n}\n\nrefresh_assets() {\n    echo \"Refreshing Loggle assets in $ASSET_CACHE_DIR\"\n    rm -rf \"$SRC_DIR\"\n    git clone --depth 1 --filter=blob:none --branch \"$REPO_REF\" \"$REPO_URL\" \"$SRC_DIR\"\n    if [[ -n \"$REPO_PATH\" && \"$REPO_PATH\" != \".\" ]]; then\n        git -C \"$SRC_DIR\" sparse-checkout init --cone\n        git -C \"$SRC_DIR\" sparse-checkout set \"$REPO_PATH\"\n    else\n        REPO_PATH=\".\"\n    fi\n\n    local assets_dir=\"$SRC_DIR/$REPO_PATH\"\n    if [[ ! -d \"$assets_dir\" ]]; then\n        echo \"Assets path $REPO_PATH not found in repository $REPO_URL\"\n        exit 1\n    fi\n\n    rm -rf \"$ASSET_CACHE_DIR\"\n    install -d -m 0755 \"$ASSET_CACHE_DIR\"\n    shopt -s dotglob\n    cp -R \"$assets_dir\"/* \"$ASSET_CACHE_DIR\"/\n    shopt -u dotglob\n\n    curl -fsSL \"$SETUP_URL\" -o \"$SETUP_SRC\"\n    chmod +x \"$SETUP_SRC\"\n}\n\nensure_prereqs\n\nif [[ ! -f \"$SETUP_SRC\" ]]; then\n    refresh_assets\nfi\n\nexport LOGGLE_DOMAIN=\"{4}\"\nexport LOGGLE_CERT_EMAIL=\"{5}\"\nexport LOGGLE_MANAGED_IDENTITY_CLIENT_ID=\"{6}\"\nexport LOGGLE_CERT_ENV=\"{7}\"\nexport LOGGLE_KEY_VAULT_NAME=\"{8}\"\nexport LOGGLE_BOOTSTRAP_STATE_FILE=\"$STATE_FILE\"\nexport LOGGLE_ASSET_DIR=\"$ASSET_CACHE_DIR\"\nchmod +x \"$SETUP_SRC\"\n\n\"$SETUP_SRC\"\n\nif [[ -n \"$STATE_FILE\" ]]; then\n    mkdir -p \"$(dirname \"$STATE_FILE\")\"\n    touch \"$STATE_FILE\"\n    chmod 600 \"$STATE_FILE\"\nfi\nSCRIPT\nset -u\nchmod +x \"$BOOTSTRAP_SCRIPT\"\n\ncat <<''SERVICE'' >/etc/systemd/system/loggle-bootstrap.service\n[Unit]\nDescription=Loggle setup runner\nWants=network-online.target cloud-final.service\nAfter=network-online.target cloud-final.service\n\n[Service]\nType=oneshot\nExecStart=/etc/loggle/loggle-bootstrap.sh\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\nSERVICE\n\nsystemctl daemon-reload\nsystemctl enable loggle-bootstrap.service\n''\n', parameters('setupScriptUrl'), parameters('assetRepoUrl'), parameters('assetRepoRef'), parameters('assetRepoPath'), parameters('domainName'), parameters('certificateEmail'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2023-01-31').clientId, parameters('letsEncryptEnvironment'), variables('keyVaultEffectiveName'))]"
        },
        "settings": {}
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]",
        "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
      ]
    }
  ],
  "outputs": {
    "publicIpAddress": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIpName')), '2023-02-01').ipAddress]"
    },
    "managedIdentityClientId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2023-01-31').clientId]"
    },
    "keyVaultResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultEffectiveName'))]"
    }
  }
}