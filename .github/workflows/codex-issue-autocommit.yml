name: Auto Codex Commit on Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  codex:
    uses: jgador/codex-issue-bot/.github/workflows/codex-issue-agent.yml@master
    with:
      base-branch: master
      branch-prefix: codex/issue-
      require-owner: true
      prompt: |
        You are Codex, an autonomous coding agent running inside a GitHub Actions job for ${{ github.repository }}.
        The workflow has already checked out the feature branch created for this issue from master; keep working on that branch.
        Follow the repository's established coding conventions.

        Context:
          - Issue number: #${{ github.event.issue.number }}
          - Issue title: ${{ github.event.issue.title }}
          - Issue body:
            ----
            ${{ github.event.issue.body }}
            ----

        Your tasks:
          1. Implement the feature or fix requested in the issue.
          2. Keep changes minimal and focused on the request.
          3. Stage only relevant files.
          4. Create one or more commits. Each commit message must start with "codex:" and include "#${{ github.event.issue.number }}".
          5. Leave the branch ready for this workflow to push (do not run git push yourself).
          6. Summarize the work and list changed files in your final response.

        Constraints:
          - Do not modify unrelated files or rewrite history.
          - Prefer using apply_patch for file edits when practical.
          - Run available tests when safe and include results in the final summary.
          - When executing tests or other long-running commands, prefix them with 'timeout 5m' to avoid hangs.
          - Do not run 'dotnet run' commands.
          - If the request is ambiguous or unsafe, stop and explain why instead of making changes.

        Begin by reviewing the issue details and the existing codebase as needed.
    secrets:
      OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
      OPENAI_RESPONSES_ENDPOINT: ${{ secrets.AZURE_OPENAI_RESPONSES_ENDPOINT }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
